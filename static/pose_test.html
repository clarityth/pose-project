<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Pose API í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #f2f4f8;
      color: #333;
    }
    h2 { color: #2c3e50; }
    form {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    input, button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background: #3498db;
      color: #fff;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #2980b9;
    }
    .results {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
      margin-top: 20px;
      display: none;
    }
    .section {
      margin-bottom: 24px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th, td {
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #ecf0f1;
    }
    .cards {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .card {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      width: calc(33.333% - 16px);
      box-sizing: border-box;
      text-align: center;
    }
    .card h4 { margin: 8px 0; font-size: 16px; }
    .videos {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }
    .video-card {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
      text-align: center;
    }
    .video-card img {
      width: 100%;
      height: auto;
      display: block;
    }
    .video-card h5 {
      margin: 8px;
      font-size: 14px;
    }
    .report {
      background: #fcfcfc;
      border-left: 4px solid #3498db;
      padding: 12px 16px;
      border-radius: 4px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    /* ì°¨íŠ¸ ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ */
    #historyChart {
      width: 100%;
      max-width: 100%;
      height: 400px;
      margin-top: 16px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- Chart.js CDN ì¶”ê°€ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h2>1. íšŒì›ê°€ì…</h2>
  <form id="registerForm">
    <input type="text" id="name" placeholder="ì´ë¦„" required>
    <input type="email" id="regEmail" placeholder="ì´ë©”ì¼" required>
    <input type="password" id="regPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
    <button type="submit">íšŒì›ê°€ì…</button>
  </form>

  <h2>2. ë¡œê·¸ì¸</h2>
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" required>
    <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
    <button type="submit">ë¡œê·¸ì¸</button>
  </form>

  <h2>3. í”„ë¡œí•„ ë“±ë¡</h2>
  <form id="profileForm">
    <input type="text" id="gender" placeholder="ì„±ë³„ (ë‚¨ì/ì—¬ì)" required>
    <input type="number" id="age" placeholder="ë‚˜ì´ (10,20,â€¦)" required>
    <input type="number" id="weight" placeholder="ëª¸ë¬´ê²Œ (kg)" required>
    <input type="number" id="height" placeholder="í‚¤ (cm)" required>
    <button type="submit">í”„ë¡œí•„ ë“±ë¡</button>
  </form>

  <h2>4. ì´ë¯¸ì§€ ì—…ë¡œë“œ & ë¶„ì„</h2>
  <form id="imageForm" enctype="multipart/form-data">
    <input type="file" id="imageFile" accept="image/*" required>
    <button type="submit">ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
  </form>

  <div id="output" class="results">
    <div class="section">
      <h3>ğŸ›  Raw Server Response</h3>
      <pre id="rawResponse" style="background:#222;color:#eee;padding:10px;border-radius:4px;overflow-x:auto;"></pre>
    </div>
    <div class="section">
      <h3>ğŸ‘¤ ì‚¬ìš©ì ì •ë³´</h3>
      <div id="renderedUserInfo">-</div>
    </div>
    <div class="section">
      <h3>ğŸ“Š Metrics & Percentiles</h3>
      <table>
        <tr><th>ì§€í‘œ</th><th>ê°’</th><th>ë°±ë¶„ìœ„</th></tr>
        <tbody id="metricsTable"></tbody>
      </table>
    </div>

    <div class="section">
      <h3>ğŸ”„ ë³€í™” ì¶”ì´</h3>
      <table>
        <tr><th>ì§€í‘œ</th><th>ë³€í™”ëŸ‰</th></tr>
        <tbody id="changesTable"></tbody>
      </table>
    </div>

    <div class="section">
      <h3>â³ ì—…ë¡œë“œ ì´ë ¥</h3>
      <table>
        <tr><th>ë§ˆì§€ë§‰ ì—…ë¡œë“œ ë‚ ì§œ</th><th>ê²½ê³¼ ì¼ìˆ˜</th></tr>
        <tr id="uploadHistoryRow">
          <td>-</td><td>-</td>
        </tr>
      </table>
    </div>

    <!-- ì—…ë¡œë“œ ì´ë ¥ ê·¸ë˜í”„ ì„¹ì…˜ ì¶”ê°€ -->
    <div class="section">
      <h3>ğŸ“ˆ ì—…ë¡œë“œ ì´ë ¥ ê·¸ë˜í”„</h3>
      <canvas id="historyChart"></canvas>
    </div>

    <div class="section">
      <h3>ğŸ” Keypoint Visuals</h3>
      <div id="images"></div>
    </div>

    <div class="section">
      <h3>ğŸ’ª ì¶”ì²œ ìš´ë™</h3>
      <div class="cards" id="recoCards"></div>
    </div>

    <div class="section">
      <h3>ğŸ¥ ì¶”ì²œ ì˜ìƒ</h3>
      <div class="videos" id="videos"></div>
    </div>

    <div class="section">
      <h3>ğŸ“ ì¢…í•© ë¦¬í¬íŠ¸</h3>
      <div class="report" id="reportText"></div>
    </div>

  </div>

  <script>
    const api = "http://127.0.0.1:8000";
    let currentUserId = null;
    let historyChartInstance = null;

    // íšŒì›ê°€ì…
    document.getElementById("registerForm").onsubmit = async e => {
      e.preventDefault();
      const res = await fetch(`${api}/register`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          name: document.getElementById("name").value,
          email: document.getElementById("regEmail").value,
          password: document.getElementById("regPassword").value
        })
      });
      const j = await res.json();
      window.alert(j.message || j.detail);
    };

    // ë¡œê·¸ì¸
    let currentUserName = null;
    document.getElementById("loginForm").onsubmit = async e => {
      e.preventDefault();
      const res = await fetch(`${api}/login`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          email: document.getElementById("loginEmail").value,
          password: document.getElementById("loginPassword").value
        })
      });
      const j = await res.json();
      if (res.ok) {
        currentUserId = j.user_id;
        currentUserName = j.name;
        document.getElementById("userInfo").textContent = "í™˜ì˜í•©ë‹ˆë‹¤, " + currentUserName;
        window.alert("ë¡œê·¸ì¸ ì„±ê³µ: user_id=" + currentUserId);
      } else {
        window.alert(j.detail || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
      }
    };

    // í”„ë¡œí•„ ë“±ë¡
    document.getElementById("profileForm").onsubmit = async e => {
      e.preventDefault();
      if (!currentUserId) return window.alert("ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.");
      const res = await fetch(`${api}/profile`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          user_id: currentUserId,
          gender: document.getElementById("gender").value,
          age: Number(document.getElementById("age").value),
          weight: Number(document.getElementById("weight").value),
          height: Number(document.getElementById("height").value)
        })
      });
      const j = await res.json();
      window.alert(j.message || j.detail);
    };

    // ê²°ê³¼ ë Œë”ë§
    async function showResult(data) {
      // Raw Response
      document.getElementById("rawResponse").textContent = JSON.stringify(data, null, 2);

      // ì‚¬ìš©ì ì •ë³´
      if (data.user) {
        document.getElementById("renderedUserInfo").innerHTML = `
          <p>ì´ë¦„: ${data.user.name}</p>
          <p>ì„±ë³„: ${data.user.gender}</p>
          <p>ë‚˜ì´: ${data.user.age}ì„¸</p>
          <p>ëª¸ë¬´ê²Œ: ${data.user.weight}kg</p>
          <p>í‚¤: ${data.user.height}cm</p>
        `;
      } else {
        document.getElementById("renderedUserInfo").textContent = '-';
      }

      document.getElementById("output").style.display = "block";

      // Metrics & Percentiles
      const mt = document.getElementById("metricsTable");
      mt.innerHTML = "";
      for (let k in data.metrics) {
        const tr = document.createElement("tr");

        // ê°’ í¬ë§·
        const metricVal = data.metrics[k] != null
          ? Number(data.metrics[k]).toFixed(2)
          : "-";

        // Percentile ì°¾ê¸°
        const baseKey = k.replace(/_(px|deg)$/, "");
        let pval = data.percentiles[k];
        if (pval == null) {
          pval = data.percentiles[baseKey];
        }
        const perc = pval != null ? pval + "%" : "-";

        tr.innerHTML = `
          <td>${k.replace(/_/g, " ")}</td>
          <td>${metricVal}</td>
          <td>${perc}</td>
        `;
        mt.appendChild(tr);
      }

      // ë³€í™” ì¶”ì´ í…Œì´ë¸”
      const ct = document.getElementById("changesTable");
      ct.innerHTML = '';
      if (data.changes) {
        for (let k in data.changes) {
          const changeVal = data.changes[k];
          const formatted = changeVal != null
            ? (changeVal >= 0 ? '+' : '') + Number(changeVal).toFixed(2)
            : "-";
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${k.replace(/_/g,' ')}</td>
            <td>${formatted}</td>
          `;
          ct.appendChild(tr);
        }
      }

      // ì—…ë¡œë“œ ì´ë ¥ ë‚ ì§œ & ê²½ê³¼ ì¼ìˆ˜
      const histRow = document.getElementById("uploadHistoryRow");
      histRow.children[0].textContent = data.last_upload_date || "-";
      histRow.children[1].textContent = data.days_since != null
        ? parseInt(data.days_since) + "ì¼"
        : "-";

      // Keypoint Visuals
      const imgs = document.getElementById("images");
      imgs.innerHTML = "";
      Object.entries(data.visuals || {}).forEach(([k, url]) => {
        const d = document.createElement("div");
        d.style.display = "inline-block";
        d.style.margin = "8px";
        d.innerHTML = `<strong>${k}</strong><br><img src="${url}" width="180">`;
        imgs.appendChild(d);
      });

      // ì¶”ì²œ ìš´ë™
      const rc = document.getElementById("recoCards");
      rc.innerHTML = "";
      (data.recommendations || []).forEach(r => {
        const c = document.createElement("div");
        c.className = "card";
        c.innerHTML = `<h4>${r.exercise}</h4><p>í™•ë¥ : ${r.probability}%</p>`;
        rc.appendChild(c);
      });

      // ì¶”ì²œ ì˜ìƒ
      const vids = document.getElementById("videos");
      vids.innerHTML = "";
      (data.videos || []).forEach(v => {
        const d = document.createElement("div");
        d.className = "video-card";
        d.innerHTML = `
          <img src="${v.thumbnail_url}" alt="${v.video_title}">
          <h5>${v.video_title}</h5>
          <p>${v.video_desc}</p>
          <a href="${v.video_url}" target="_blank">ì˜ìƒ ë³´ê¸°</a>
        `;
        vids.appendChild(d);
      });

      // ì¢…í•© ë¦¬í¬íŠ¸
      document.getElementById("reportText").innerText = data.report;
      document.getElementById("reportText").parentElement.style.display = 'block';

      // ì—…ë¡œë“œ ì´ë ¥(History) ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
      renderHistoryChart(data.history || []);
    }

    // ì—…ë¡œë“œ ì´ë ¥ ê·¸ë˜í”„ ë Œë”ë§ í•¨ìˆ˜
    function renderHistoryChart(historyData) {
      const ctx = document.getElementById("historyChart").getContext("2d");

      // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ íŒŒê´´
      if (historyChartInstance) {
        historyChartInstance.destroy();
      }

      if (!historyData.length) {
        // ë°ì´í„° ì—†ìœ¼ë©´ ë¹ˆ ê·¸ë˜í”„ ìƒì„±
        historyChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: [],
            datasets: []
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false },
              title: { display: true, text: 'ì—…ë¡œë“œ ì´ë ¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' }
            }
          }
        });
        return;
      }

      // ë¼ë²¨(ë‚ ì§œ) ë°°ì—´: created_atì„ í•œêµ­ ì‹œê°„ ë¡œì»¬ ë¬¸ìì—´ë¡œ ë³€í™˜
      const labels = historyData.map(item => {
        const d = new Date(item.created_at);
        return d.toLocaleString('ko-KR', { hour12: false });
      });

      // ê° ì§€í‘œ í‚¤ ëª©ë¡
      const metricKeys = [
        "shoulder_height_diff_px",
        "hip_height_diff_px",
        "torso_vertical_tilt_deg",
        "ear_hip_vertical_tilt_deg",
        "shoulder_line_horizontal_tilt_deg",
        "hip_line_horizontal_tilt_deg"
      ];

      // ì°¨íŠ¸ ìƒ‰ìƒ ë°°ì—´ (ì§€í‘œë³„ë¡œ êµ¬ë¶„)
      const colors = [
        'rgba(231, 76, 60, 0.8)',    // ë¹¨ê°•
        'rgba(52, 152, 219, 0.8)',   // íŒŒë‘
        'rgba(46, 204, 113, 0.8)',   // ì´ˆë¡
        'rgba(155, 89, 182, 0.8)',   // ë³´ë¼
        'rgba(241, 196, 15, 0.8)',   // ë…¸ë‘
        'rgba(26, 188, 156, 0.8)'    // ì²­ë¡
      ];

      // ë°ì´í„°ì…‹ ë°°ì—´ ìƒì„±
      const datasets = metricKeys.map((key, idx) => {
        return {
          label: key.replace(/_/g, ' '),
          data: historyData.map(item => {
            const val = item[key];
            return val != null ? Number(val) : null;
          }),
          fill: false,
          borderColor: colors[idx],
          tension: 0.3,
          pointRadius: 4
        };
      });

      // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
      historyChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          responsive: true,
          interaction: {
            mode: 'index',
            intersect: false
          },
          stacked: false,
          plugins: {
            title: {
              display: true,
              text: 'ì—…ë¡œë“œ ì´ë ¥ë³„ ì§€í‘œ ë³€í™” ê·¸ë˜í”„'
            }
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'ì—…ë¡œë“œ ë‚ ì§œ (KST)'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'ê°’'
              }
            }
          }
        }
      });
    }

    // ì´ë¯¸ì§€ ì—…ë¡œë“œ
    document.getElementById("imageForm").onsubmit = async e => {
      e.preventDefault();
      if (!currentUserId) return window.alert("ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.");
      const fd = new FormData();
      fd.append("file", document.getElementById("imageFile").files[0]);
      const res = await fetch(`${api}/upload-image?user_id=${currentUserId}`, {
        method: "POST", body: fd
      });
      const j = await res.json();
      if (!res.ok) {
        window.alert(j.detail || j.message || "ì—…ë¡œë“œ ì‹¤íŒ¨");
        return;
      }
      await showResult(j);
      window.alert("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
    };
  </script>
</body>
</html>