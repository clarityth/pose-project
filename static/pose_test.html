<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Pose API í…ŒìŠ¤íŠ¸</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      padding: 20px;
      max-width: 900px;
      margin: auto;
      background: #f2f4f8;
      color: #333;
    }
    h2 {
      color: #2c3e50;
    }
    form {
      background: #fff;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 24px;
    }
    input,
    button {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background: #3498db;
      color: #fff;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #2980b9;
    }
    .results {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
      display: none;
    }
    .section {
      margin-bottom: 24px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    th,
    td {
      padding: 8px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #ecf0f1;
    }
    .composite-box {
      background: #fcfcfc;
      border-left: 4px solid #3498db;
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 24px;
      font-weight: bold;
    }
    .cards {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }
    .card {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 12px;
      width: calc(33.333% - 16px);
      box-sizing: border-box;
      text-align: center;
    }
    .card h4 {
      margin: 8px 0;
      font-size: 16px;
    }
    .videos {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }
    .video-card {
      background: #fafafa;
      border: 1px solid #ddd;
      border-radius: 6px;
      overflow: hidden;
      text-align: center;
    }
    .video-card img {
      width: 100%;
      height: auto;
      display: block;
    }
    .video-card h5 {
      margin: 8px;
      font-size: 14px;
    }
    .report {
      background: #fcfcfc;
      border-left: 4px solid #3498db;
      padding: 12px 16px;
      border-radius: 4px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    /* ì°¨íŠ¸ ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ */
    #historyChart,
    #normalDistChart {
      width: 100%;
      max-width: 100%;
      height: 400px;
      margin-top: 16px;
    }
  </style>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>1. íšŒì›ê°€ì…</h2>
  <form id="registerForm">
    <input type="text" id="name" placeholder="ì´ë¦„" required />
    <input type="email" id="regEmail" placeholder="ì´ë©”ì¼" required />
    <input type="password" id="regPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required />
    <button type="submit">íšŒì›ê°€ì…</button>
  </form>

  <h2>2. ë¡œê·¸ì¸</h2>
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" required />
    <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required />
    <button type="submit">ë¡œê·¸ì¸</button>
  </form>

  <h2>3. í”„ë¡œí•„ ë“±ë¡</h2>
  <form id="profileForm">
    <input type="text" id="gender" placeholder="ì„±ë³„ (ë‚¨ì/ì—¬ì)" required />
    <input type="number" id="age" placeholder="ë‚˜ì´ (10,20,â€¦)" required />
    <input type="number" id="weight" placeholder="ëª¸ë¬´ê²Œ (kg)" required />
    <input type="number" id="height" placeholder="í‚¤ (cm)" required />
    <button type="submit">í”„ë¡œí•„ ë“±ë¡</button>
  </form>

  <h2>4. ì´ë¯¸ì§€ ì—…ë¡œë“œ &amp; ë¶„ì„</h2>
  <form id="imageForm" enctype="multipart/form-data">
    <input type="file" id="imageFile" accept="image/*" required />
    <button type="submit">ì´ë¯¸ì§€ ì—…ë¡œë“œ</button>
  </form>

  <div id="output" class="results">
    <div class="section">
      <h3>ğŸ›  Raw Server Response</h3>
      <pre
        id="rawResponse"
        style="background:#222;color:#eee;padding:10px;border-radius:4px;overflow-x:auto;"
      ></pre>
    </div>
    <div class="section">
      <h3>ğŸ‘¤ ì‚¬ìš©ì ì •ë³´</h3>
      <div id="renderedUserInfo">-</div>
    </div>

    <!-- ì¢…í•© í¼ì„¼íƒ€ì¼ ì„¹ì…˜ ì¶”ê°€ -->
    <div class="composite-box">
      ì¢…í•©ì ìˆ˜ í¼ì„¼íƒ€ì¼: <span id="compositePercentile">-</span>%
    </div>

    <div class="section">
      <h3>ğŸ“Š Metrics</h3>
      <table>
        <tr><th>ì§€í‘œ</th><th>ê°’</th></tr>
        <tbody id="metricsTable"></tbody>
      </table>
    </div>

    <div class="section">
      <h3>ğŸ”„ ë³€í™” ì¶”ì´</h3>
      <table>
        <tr><th>ì§€í‘œ</th><th>ë³€í™”ëŸ‰</th></tr>
        <tbody id="changesTable"></tbody>
      </table>
    </div>

    <div class="section">
      <h3>â³ ì—…ë¡œë“œ ì´ë ¥</h3>
      <table>
        <tr><th>ë§ˆì§€ë§‰ ì—…ë¡œë“œ ë‚ ì§œ</th><th>ê²½ê³¼ ì¼ìˆ˜</th></tr>
        <tr id="uploadHistoryRow">
          <td>-</td><td>-</td>
        </tr>
      </table>
    </div>

    <!-- ì—…ë¡œë“œ ì´ë ¥ ê·¸ë˜í”„ -->
    <div class="section">
      <h3>ğŸ“ˆ ì—…ë¡œë“œ ì´ë ¥ ê·¸ë˜í”„</h3>
      <canvas id="historyChart"></canvas>
    </div>

    <!-- ì •ê·œ ë¶„í¬ ê·¸ë˜í”„: composite_min/max ë²”ìœ„ë¡œ ê·¸ë¦¬ë„ë¡ -->
    <div class="section">
      <h3>ğŸ“Š ì¢…í•©ì ìˆ˜ ì •ê·œ ë¶„í¬</h3>
      <canvas id="normalDistChart"></canvas>
    </div>

    <div class="section">
      <h3>ğŸ” Keypoint Visuals</h3>
      <div id="images"></div>
    </div>

    <div class="section">
      <h3>ğŸ’ª ì¶”ì²œ ìš´ë™</h3>
      <div class="cards" id="recoCards"></div>
    </div>

    <div class="section">
      <h3>ğŸ¥ ì¶”ì²œ ì˜ìƒ</h3>
      <div class="videos" id="videos"></div>
    </div>

    <div class="section">
      <h3>ğŸ“ ì¢…í•© ë¦¬í¬íŠ¸</h3>
      <div class="report" id="reportText"></div>
    </div>
  </div>

  <script>
  const api = "http://localhost:8000";

  let currentUserEmail = null;
  let historyChartInstance = null;
  let normalDistChartInstance = null;

  document.getElementById("registerForm").onsubmit = async (e) => {
    e.preventDefault();
    const res = await fetch(`${api}/register`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        name: document.getElementById("name").value,
        email: document.getElementById("regEmail").value,
        password: document.getElementById("regPassword").value,
      }),
    });
    const j = await res.json();
    window.alert(j.message || j.detail);
  };

  document.getElementById("loginForm").onsubmit = async (e) => {
    e.preventDefault();
    const emailVal = document.getElementById("loginEmail").value;
    const res = await fetch(`${api}/login`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email: emailVal,
        password: document.getElementById("loginPassword").value,
      }),
    });
    const j = await res.json();
    if (res.ok) {
      currentUserEmail = j.email || emailVal;
      window.alert("ë¡œê·¸ì¸ ì„±ê³µ: " + currentUserEmail);
    } else {
      window.alert(j.detail || "ë¡œê·¸ì¸ ì‹¤íŒ¨");
    }
  };

  document.getElementById("profileForm").onsubmit = async (e) => {
    e.preventDefault();
    if (!currentUserEmail) return window.alert("ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.");
    const res = await fetch(`${api}/profile`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        email: currentUserEmail,
        gender: document.getElementById("gender").value,
        age: Number(document.getElementById("age").value),
        weight: Number(document.getElementById("weight").value),
        height: Number(document.getElementById("height").value),
      }),
    });
    const j = await res.json();
    window.alert(j.message || j.detail);
  };

  document.getElementById("imageForm").onsubmit = async (e) => {
    e.preventDefault();
    if (!currentUserEmail) return window.alert("ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.");
    const fd = new FormData();
    fd.append("file", document.getElementById("imageFile").files[0]);
    fd.append("email", currentUserEmail);
    const res = await fetch(`${api}/upload-image`, {
      method: "POST",
      body: fd,
    });
    const j = await res.json();
    if (!res.ok) {
      window.alert(j.detail || j.message || "ì—…ë¡œë“œ ì‹¤íŒ¨");
      return;
    }
    await showResult(j);
    window.alert("ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
  };

  async function showResult(data) {
    document.getElementById("rawResponse").textContent = JSON.stringify(
      data,
      null,
      2
    );

    if (data.user) {
      document.getElementById("renderedUserInfo").innerHTML = `
        <p>ì´ë¦„: ${data.user.name}</p>
        <p>ì„±ë³„: ${data.user.gender}</p>
        <p>ë‚˜ì´: ${data.user.age}ì„¸</p>
        <p>ëª¸ë¬´ê²Œ: ${data.user.weight}kg</p>
        <p>í‚¤: ${data.user.height}cm</p>
      `;
    } else {
      document.getElementById("renderedUserInfo").textContent = "-";
    }

    document.getElementById("compositePercentile").textContent =
      data.composite_percentile != null ? data.composite_percentile : "-";
    document.getElementById("output").style.display = "block";

    const mt = document.getElementById("metricsTable");
    mt.innerHTML = "";
    for (let k in data.metrics) {
      const tr = document.createElement("tr");
      const metricVal = data.metrics[k] != null ? Number(data.metrics[k]).toFixed(2) : "-";
      tr.innerHTML = `
        <td>${k.replace(/_/g, " ")}</td>
        <td>${metricVal}</td>
      `;
      mt.appendChild(tr);
    }

    const ct = document.getElementById("changesTable");
    ct.innerHTML = "";
    if (data.changes) {
      for (let k in data.changes) {
        const changeVal = data.changes[k];
        const formatted =
          changeVal != null ? (changeVal >= 0 ? "+" : "") + Number(changeVal).toFixed(2) : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${k.replace(/_/g, " ")}</td>
          <td>${formatted}</td>
        `;
        ct.appendChild(tr);
      }
    }

    const histRow = document.getElementById("uploadHistoryRow");
    histRow.children[0].textContent = data.last_upload_date || "-";
    histRow.children[1].textContent =
      data.days_since != null ? parseInt(data.days_since) + "ì¼" : "-";

    const imgs = document.getElementById("images");
    imgs.innerHTML = "";
    Object.entries(data.visuals || {}).forEach(([k, url]) => {
      const d = document.createElement("div");
      d.style.display = "inline-block";
      d.style.margin = "8px";
      d.innerHTML = `<strong>${k}</strong><br><img src="${url}" width="180" />`;
      imgs.appendChild(d);
    });

    const rc = document.getElementById("recoCards");
    rc.innerHTML = "";
    (data.recommendations || []).forEach((r) => {
      const c = document.createElement("div");
      c.className = "card";
      c.innerHTML = `<h4>${r.exercise}</h4><p>í™•ë¥ : ${r.probability}%</p>`;
      rc.appendChild(c);
    });

    const vids = document.getElementById("videos");
    vids.innerHTML = "";
    (data.videos || []).forEach((v) => {
      const d = document.createElement("div");
      d.className = "video-card";
      d.innerHTML = `
        <img src="${v.thumbnail_url}" alt="${v.video_title}" />
        <h5>${v.video_title}</h5>
        <p>${v.video_desc}</p>
        <a href="${v.video_url}" target="_blank">ì˜ìƒ ë³´ê¸°</a>
      `;
      vids.appendChild(d);
    });

    document.getElementById("reportText").innerText = data.report;
    document.getElementById("reportText").parentElement.style.display = "block";

    renderHistoryChart(data.history || []);
    renderNormalDistChart(
      data.composite_mean,
      data.composite_std,
      data.composite_percentile,
      data.composite_min,
      data.composite_max
    );
  }

  function renderHistoryChart(historyData) {
    const ctx = document.getElementById("historyChart").getContext("2d");

    if (historyChartInstance) historyChartInstance.destroy();

    if (!historyData.length) {
      historyChartInstance = new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets: [] },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: "ì—…ë¡œë“œ ì´ë ¥ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤." },
          },
        },
      });
      return;
    }

    const labels = historyData.map((item) => {
      const d = new Date(item.created_at);
      return d.toLocaleString("ko-KR", { hour12: false });
    });

    const metricKeys = [
      "shoulder_height_diff_px",
      "hip_height_diff_px",
      "torso_vertical_tilt_deg",
      "ear_hip_vertical_tilt_deg",
      "shoulder_line_horizontal_tilt_deg",
      "hip_line_horizontal_tilt_deg",
    ];

    const colors = [
      "rgba(231, 76, 60, 0.8)",
      "rgba(52, 152, 219, 0.8)",
      "rgba(46, 204, 113, 0.8)",
      "rgba(155, 89, 182, 0.8)",
      "rgba(241, 196, 15, 0.8)",
      "rgba(26, 188, 156, 0.8)",
    ];

    const datasets = metricKeys.map((key, idx) => {
      return {
        label: key.replace(/_/g, " "),
        data: historyData.map((item) => {
          const val = item[key];
          return val != null ? Number(val) : null;
        }),
        fill: false,
        borderColor: colors[idx],
        tension: 0.3,
        pointRadius: 4,
      };
    });

    historyChartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: datasets,
      },
      options: {
        responsive: true,
        interaction: {
          mode: "index",
          intersect: false,
        },
        stacked: false,
        plugins: {
          title: {
            display: true,
            text: "ì—…ë¡œë“œ ì´ë ¥ë³„ ì§€í‘œ ë³€í™” ê·¸ë˜í”„",
          },
        },
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: "ì—…ë¡œë“œ ë‚ ì§œ (KST)",
            },
          },
          y: {
            display: true,
            title: {
              display: true,
              text: "ê°’",
            },
          },
        },
      },
    });
  }

  function renderNormalDistChart(mean, std, percentile, minVal, maxVal) {
    const ctx = document.getElementById("normalDistChart").getContext("2d");

    if (normalDistChartInstance) normalDistChartInstance.destroy();

    if (
      mean == null ||
      std == null ||
      std <= 0 ||
      minVal == null ||
      maxVal == null ||
      minVal >= maxVal
    ) {
      normalDistChartInstance = new Chart(ctx, {
        type: "line",
        data: { labels: [], datasets: [] },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: true, text: "ì •ê·œ ë¶„í¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤." },
          },
        },
      });
      return;
    }

    const xMin = minVal;
    const xMax = maxVal;
    const step = (xMax - xMin) / 100;

    const xValues = [];
    const yValues = [];

    for (let x = xMin; x <= xMax + 1e-9; x += step) {
      const exponent = -0.5 * Math.pow((x - mean) / std, 2);
      const y = (1 / (std * Math.sqrt(2 * Math.PI))) * Math.exp(exponent);
      xValues.push(x);
      yValues.push(y);
    }

    const x_user = percentileToX(mean, std, percentile);
    const x_user_clamped = Math.min(Math.max(x_user, xMin), xMax);
    const y_user =
      (1 / (std * Math.sqrt(2 * Math.PI))) *
      Math.exp(-0.5 * Math.pow((x_user_clamped - mean) / std, 2));

    const userPoint = { x: x_user_clamped, y: y_user };

    normalDistChartInstance = new Chart(ctx, {
      type: "line",
      data: {
        labels: xValues.map((val) => val.toFixed(2)),
        datasets: [
          {
            label: "ì •ê·œ ë¶„í¬ ê³¡ì„ ",
            data: yValues,
            borderColor: "rgba(52, 152, 219, 0.8)",
            fill: false,
            tension: 0.2,
            pointRadius: 0,
          },
          {
            label: "ì‚¬ìš©ì ìœ„ì¹˜",
            data: [
              {
                x: userPoint.x,
                y: userPoint.y,
              },
            ],
            backgroundColor: "rgba(231, 76, 60, 0.8)",
            type: "scatter",
            pointRadius: 6,
            showLine: false,
          },
        ],
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: "linear",
            position: "bottom",
            title: {
              display: true,
              text: "ì¢…í•©ì ìˆ˜",
            },
            min: xMin,
            max: xMax,
          },
          y: {
            display: true,
            title: {
              display: true,
              text: "í™•ë¥  ë°€ë„",
            },
            suggestedMin: 0,
            suggestedMax: Math.max(...yValues) * 1.2,
          },
        },
        plugins: {
          title: {
            display: true,
            text: `ì •ê·œ ë¶„í¬ (Î¼=${mean.toFixed(2)}, Ïƒ=${std.toFixed(2)})`,
          },
          tooltip: {
            mode: "nearest",
            intersect: false,
            callbacks: {
              label: (ctx) => {
                const p = ctx.raw;
                return `ì ìˆ˜: ${p.x.toFixed(2)}, ë°€ë„: ${p.y.toFixed(3)}`;
              },
            },
          },
          legend: {
            display: false,
          },
        },
      },
    });
  }

  function percentileToX(mean, std, percentile) {
    function inverseErf(x) {
      const a = 0.147;
      const sign = x < 0 ? -1 : 1;
      const lnTerm = Math.log(1 - x * x);
      const firstPart = 2 / (Math.PI * a) + lnTerm / 2;
      const secondPart = lnTerm / a;
      return (
        sign *
        Math.sqrt(Math.sqrt(firstPart * firstPart - secondPart) - firstPart)
      );
    }
    const p = percentile / 100;
    const z = Math.SQRT2 * inverseErf(2 * p - 1);
    return mean + std * z;
  }
  </script>
</body>
</html>